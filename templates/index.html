<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Image Search App</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>
<body>
    <h1>Image Search App</h1>

    <section id="upload-section">
        <h2>Upload Image</h2>
        <form id="uploadForm" enctype="multipart/form-data">
            <input type="file" name="image" accept="image/*" required />
            <button type="submit">Upload</button>
        </form>
        <p id="uploadStatus"></p>
    </section>

    <section id="search-section">
        <h2>Search Images</h2>
        <input type="text" id="searchInput" placeholder="Search description..." />
        <button id="searchButton">Search</button>
    </section>

    <section id="results-section">
        <h2>Results</h2>
        <div id="results"></div>
    </section>

    <script>
        const uploadForm = document.getElementById('uploadForm');
        const uploadStatus = document.getElementById('uploadStatus');
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const resultsDiv = document.getElementById('results');

        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            uploadStatus.textContent = "Uploading...";

            const formData = new FormData(uploadForm);
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData,
                });
                const data = await response.json();

                if (response.ok) {
                    uploadStatus.textContent = `Uploaded: ${data.filename}`;
                    // Clear search and results on new upload
                    searchInput.value = '';
                    resultsDiv.innerHTML = '';
                } else {
                    uploadStatus.textContent = `Error: ${data.error}`;
                }
            } catch (error) {
                uploadStatus.textContent = `Upload failed: ${error.message}`;
            }
        });

        searchButton.addEventListener('click', async () => {
            const query = searchInput.value.trim();
            resultsDiv.innerHTML = "Searching...";

            if (!query) {
                resultsDiv.innerHTML = "Please enter a search term.";
                return;
            }

            try {
                const response = await fetch('/search', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query}),
                });

                const data = await response.json();

                if (data.results.length === 0) {
                    resultsDiv.innerHTML = "No images found.";
                } else {
                    resultsDiv.innerHTML = '';
                    data.results.forEach(({filename, url}) => {
                        const img = document.createElement('img');
                        img.src = url;
                        img.alt = filename;
                        img.title = filename;
                        img.classList.add('result-image');
                        resultsDiv.appendChild(img);
                    });
                }
            } catch (error) {
                resultsDiv.innerHTML = `Search failed: ${error.message}`;
            }
        });
    </script>
</body>
</html>
